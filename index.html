<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Four-Way Match Play Scorer</title>
  <style>
    :root{
      --bg:#0b5d2a; --panel:#0e7a36; --panel-dark:#0c6a2f; --text:#ffffff;
      --muted:#c8e6c9; --accent:#ffdf5d; --danger:#ff6b6b; --ok:#9be69b;
      --shadow:0 8px 20px rgba(0,0,0,.25); --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;
      background:linear-gradient(180deg,var(--bg),#064b22 70%);
      color:var(--text); min-height:100dvh;
    }
    header{padding:16px 14px; position:sticky; top:0; z-index:20;
      background:linear-gradient(180deg,rgba(0,0,0,.35),rgba(0,0,0,0)); backdrop-filter:saturate(1.2) blur(2px);}
    .logo{font-weight:800; letter-spacing:.4px;}
    .wrap{max-width:1100px; margin:0 auto; padding:16px;}
    .card{
      background:linear-gradient(180deg,var(--panel),var(--panel-dark));
      border-radius:var(--radius); box-shadow:var(--shadow);
      padding:18px; margin:14px 0; border:1px solid rgba(255,255,255,.08);
    }
    h1,h2,h3{margin:6px 0 10px; font-weight:800}
    h1{font-size:1.55rem} h2{font-size:1.25rem} h3{font-size:1.05rem; color:var(--muted)}
    p{margin:8px 0 12px; color:#eef8ee}
    .grid{display:grid; gap:12px}
    .cols-2{grid-template-columns:repeat(2,1fr)}
    .cols-3{grid-template-columns:repeat(3,1fr)}
    .cols-4{grid-template-columns:repeat(4,1fr)}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .pill{padding:10px 12px; border-radius:999px; border:1px solid rgba(255,255,255,.18); font-weight:700; background:rgba(0,0,0,.12)}
    .btn{display:inline-flex; align-items:center; justify-content:center; gap:.5rem;
      background:#124f27; color:var(--text); border:1px solid rgba(255,255,255,.12);
      padding:12px 14px; border-radius:14px; font-weight:700; cursor:pointer;
      transition:.15s transform,.15s background,.15s box-shadow; box-shadow:0 2px 0 rgba(0,0,0,.35);
      user-select:none; -webkit-tap-highlight-color:transparent;}
    .btn:hover{background:#176634} .btn:active{transform:translateY(1px)} .btn[disabled]{opacity:.45; pointer-events:none}
    .btn.primary{background:linear-gradient(180deg,#1a8d43,#14793a)} .btn.gold{background:linear-gradient(180deg,#ffe27e,#efc849); color:#2a2500}
    .btn.ghost{background:transparent; border-color:rgba(255,255,255,.25)}
    input[type="text"], input[type="number"]{
      width:100%; padding:12px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.22);
      background:rgba(0,0,0,.18); color:var(--text); font-weight:700;
    }
    .stepper{display:flex; gap:8px; margin-bottom:12px}
    .step{display:flex; align-items:center; gap:8px}
    .step .dot{width:24px; height:24px; border-radius:50%; display:grid; place-items:center; font-weight:800;
      background:rgba(0,0,0,.3); border:1px solid rgba(255,255,255,.18)}
    .step.done .dot{background:var(--ok); color:#053a13}
    .step.active .dot{background:var(--accent); color:#3a3200}
    .keypad{display:grid; grid-template-columns:repeat(6,1fr); gap:8px;}
    .keypad .btn{padding:14px 0}
    table{width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border-radius:14px}
    th,td{padding:10px 12px; text-align:center; font-weight:800}
    thead th{background:rgba(0,0,0,.15)}
    tbody tr:nth-child(odd) td{background:rgba(0,0,0,.10)}
    tbody tr:nth-child(even) td{background:rgba(0,0,0,.05)}
    td.self{background:rgba(255,255,255,.04); color:#bcd9bd}
    .badge{display:inline-block; padding:4px 8px; border-radius:999px; background:rgba(0,0,0,.28); font-size:.85rem}
    .badge.score.selected{background:#ffe27e; color:#2a2500; box-shadow:0 0 0 2px rgba(0,0,0,.25) inset;}
    .up{background:#2fbf71; color:#08361c}
    .down{background:#ff9aa2; color:#4a0808}
    .as{background:#ffe27e; color:#3d2f00}
    .footer{opacity:.8; font-size:.9rem; margin-top:8px}

    /* Head-to-head grid visuals (stronger borders so it's obvious) */
    #matchGrid table.h2h { width:100%; border-collapse:separate; border-spacing:0; border-radius:14px; overflow:hidden; }
    #matchGrid thead th { background:rgba(0,0,0,.15); border-bottom:1px solid rgba(255,255,255,.12); }
    #matchGrid th, #matchGrid td { border-right:1px solid rgba(255,255,255,.08); }
    #matchGrid tr > *:last-child { border-right:none; }
    #matchGrid tbody td { background:rgba(0,0,0,.06); }

    @media (max-width:760px){
      h1{font-size:1.25rem}
      .cols-3{grid-template-columns:repeat(2,1fr)}
      .cols-4{grid-template-columns:repeat(2,1fr)}
      th,td{padding:8px 8px}
    }
  </style>
</head>
<body>
  <header class="wrap">
    <div class="row" style="align-items:center; justify-content:space-between">
      <div class="logo">üèåÔ∏è‚Äç‚ôÇÔ∏è Four-Way Match Play</div>
      <div class="row">
        <button class="btn ghost" id="resumeBtn" style="display:none">‚Ü©Ô∏é Resume</button>
        <button class="btn ghost" id="resetBtn">Reset</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- Step 1 -->
    <section class="card step-card" data-step="1" id="step1">
      <div class="stepper" id="stepper"></div>
      <h1>Step 1 ‚Äî Select number of players</h1>
      <p>Choose how many golfers are playing today.</p>
      <div class="grid cols-4" id="playerCountBtns"></div>
      <div class="footer">Supports 2‚Äì4 players for round-robin match play.</div>
    </section>

    <!-- Step 2 -->
    <section class="card step-card" data-step="2" id="step2" hidden>
      <div class="stepper" id="stepper2"></div>
      <h1>Step 2 ‚Äî Enter player names</h1>
      <div id="nameInputs" class="grid cols-2"></div>
      <div class="row" style="margin-top:12px">
        <button class="btn ghost" id="backTo1">Back</button>
        <button class="btn primary" id="toStep3">Next</button>
      </div>
    </section>

    <!-- Step 3 -->
    <section class="card step-card" data-step="3" id="step3" hidden>
      <div class="stepper" id="stepper3"></div>
      <h1>Step 3 ‚Äî Round setup</h1>
      <div class="grid cols-3">
        <div class="card" style="padding:12px">
          <h3>Holes</h3>
          <div class="row" id="holesBtns"></div>
        </div>
        <div class="card" style="padding:12px">
          <h3>Play for money?</h3>
          <div class="row" id="moneyBtns"></div>
        </div>
        <div class="card" style="padding:12px">
          <h3>Bet type & amount</h3>
          <div class="row">
            <button class="btn" id="straightBtn">Straight</button>
            <button class="btn" id="nassauBtn" title="18 holes only">Nassau</button>
            <input type="number" id="betAmount" class="grow" min="1" step="1" placeholder="$ Units" />
          </div>
          <div class="footer">Nassau awards Front, Back, and Overall (3 units); enabled only for 18 holes.</div>
        </div>
      </div>
      <div class="row" style="margin-top:12px">
        <button class="btn gold" id="startRoundBtn">Start Round</button>
      </div>
    </section>

    <!-- Scoring -->
    <section class="card" id="scoring" hidden>
      <div class="row" style="align-items:center; justify-content:space-between">
        <div>
          <h1 id="roundTitle">Match Scoring</h1>
          <div class="row" id="playerTags"></div>
        </div>
        <div class="pill">Holes: <span id="holesPill">‚Äî</span> ‚Ä¢ Bet: <span id="betPill">None</span></div>
      </div>

      <div class="card" style="padding:14px; margin-top:10px">
        <div class="row" style="align-items:center; justify-content:space-between; gap:10px">
          <div class="row" style="align-items:center; gap:10px">
            <span class="pill">Hole <span id="holeNum">1</span></span>
            <button class="btn ghost" id="prevHole">‚óÄ Prev</button>
            <button class="btn ghost" id="nextHole">Next ‚ñ∂</button>
          </div>
          <div class="pill">Enter scores (‚Üê 3 4 5 6 ‚Üí)</div>
        </div>
        <div id="keypads"></div>
      </div>

      <div class="card">
        <h2 style="margin-bottom:8px">Head-to-Head Match Grid</h2>
        <div id="matchGrid"></div>
        <div id="payouts" class="footer"></div>
      </div>
    </section>
  </main>

  <script>
  // --------- State ---------
  const STORE_KEY = 'four_way_match_play_v4';
  let state = {
    numPlayers: 4,
    players: ['','','',''], // blank by default; fallback labels only for display
    holes: 18,
    money: { playing:false, type:'straight', unit:'' },
    scores: [], // [hole][player] -> score or null
    hole: 1
  };

  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));
  const save = ()=> localStorage.setItem(STORE_KEY, JSON.stringify(state));
  const load = ()=> { try{return JSON.parse(localStorage.getItem(STORE_KEY));}catch{return null;} };
  const clearStore = ()=> localStorage.removeItem(STORE_KEY);

  function initScores(){
    state.scores = Array.from({length: state.holes}, ()=> Array(state.numPlayers).fill(null));
  }

  // --------- Stepper ---------
  function renderStepper(targetId, active){
    const labels = ['Players','Names','Round'];
    const el = document.getElementById(targetId);
    if(!el) return;
    el.innerHTML = '';
    labels.forEach((lab,i)=>{
      const div = document.createElement('div');
      div.className = 'step' + (i+1===active ? ' active' : i+1<active ? ' done' : '');
      div.innerHTML = `<div class="dot">${i+1}</div> <div>${lab}</div>`;
      el.appendChild(div);
    });
  }

  function showStep(n){
    $$('.step-card').forEach(sec=> sec.hidden = sec.dataset.step != String(n));
    renderStepper('stepper', n);
    renderStepper('stepper2', n);
    renderStepper('stepper3', n);
  }

  // --------- Step 1 ---------
  function renderStep1(){
    const box = $('#playerCountBtns'); box.innerHTML = '';
    [2,3,4].forEach(n=>{
      const b = document.createElement('button');
      b.className = 'btn' + (state.numPlayers===n?' primary':'');
      b.textContent = n + ' Players';
      b.onclick = ()=>{ state.numPlayers = n; save(); showStep(2); renderStep2(); };
      box.appendChild(b);
    });
  }

  // --------- Step 2 ---------
  function renderStep2(){
    const wrap = $('#nameInputs'); wrap.innerHTML='';
    for(let i=0;i<state.numPlayers;i++){
      const dv = document.createElement('div');
      dv.innerHTML = `<label style="display:block; margin-bottom:6px; font-weight:700">Player ${i+1}</label>
        <input type="text" id="pname_${i}" value="${state.players[i]||''}" placeholder="Name" />`;
      wrap.appendChild(dv);
    }
    $('#backTo1').onclick = ()=> showStep(1);
    $('#toStep3').onclick = ()=>{
      for(let i=0;i<state.numPlayers;i++){
        const v = ($('#pname_'+i).value||'').trim();
        state.players[i] = v; // keep blank if blank
      }
      save();
      showStep(3); renderStep3();
    };
  }

  // --------- Step 3 ---------
  function renderStep3(){
    // holes
    const hb = $('#holesBtns'); hb.innerHTML='';
    [9,18].forEach(h=>{
      const b = document.createElement('button');
      b.className = 'btn' + (state.holes===h?' primary':'');
      b.textContent = h + ' Holes';
      b.onclick = ()=>{ state.holes = h; if(state.money.type==='nassau' && h!==18) state.money.type='straight'; save(); renderStep3(); };
      hb.appendChild(b);
    });

    // money yes/no
    const mb = $('#moneyBtns'); mb.innerHTML='';
    ['No','Yes'].forEach((lab,idx)=>{
      const val = !!idx;
      const b = document.createElement('button');
      b.className = 'btn' + (state.money.playing===val?' primary':'');
      b.textContent = lab;
      b.onclick = ()=>{ state.money.playing = val; save(); renderStep3(); };
      mb.appendChild(b);
    });

    // bet type + value
    const straightBtn = $('#straightBtn');
    const nassauBtn = $('#nassauBtn');
    const betInput = $('#betAmount');

    straightBtn.classList.toggle('primary', state.money.type==='straight');
    nassauBtn.classList.toggle('primary', state.money.type==='nassau');
    nassauBtn.disabled = state.holes!==18;

    betInput.value = (state.money.unit!=='' && state.money.unit!=null) ? state.money.unit : '';
    straightBtn.onclick = ()=>{ state.money.type='straight'; save(); renderStep3(); };
    nassauBtn.onclick = ()=>{ if(state.holes===18){ state.money.type='nassau'; save(); renderStep3(); } };
    betInput.oninput = (e)=>{
      const n = parseInt(e.target.value||'',10);
      state.money.unit = Number.isFinite(n) ? n : '';
      save();
    };

    // start round
    $('#startRoundBtn').onclick = ()=>{
      initScores();
      state.hole = 1;
      save();
      $('#step1').hidden = true; $('#step2').hidden = true; $('#step3').hidden = true;
      $('#scoring').hidden = false;
      renderScoring();
    };
  }

  // --------- Scoring ---------
  function renderScoring(){
    // Pills
    $('#holesPill').textContent = state.holes;
    const betTxt = state.money.playing ? ((state.money.type==='nassau'?'Nassau ':'Straight ') + (state.money.unit!==''? '$'+state.money.unit : '$‚Äî')) : 'None';
    $('#betPill').textContent = betTxt;

    // Player tags
    const pt = $('#playerTags'); pt.innerHTML='';
    for(let i=0;i<state.numPlayers;i++){
      const name = state.players[i] && state.players[i].trim() ? state.players[i].trim() : `Player ${i+1}`;
      const tag = document.createElement('div'); tag.className='pill'; tag.textContent = name; pt.appendChild(tag);
    }

    // Hole nav
    $('#holeNum').textContent = state.hole;
    $('#prevHole').onclick = ()=>{ state.hole = clamp(state.hole-1,1,state.holes); save(); renderScoring(); };
    $('#nextHole').onclick = ()=>{ state.hole = clamp(state.hole+1,1,state.holes); save(); renderScoring(); };

    // Keypads
    const keypads = $('#keypads'); keypads.innerHTML='';
    for(let i=0;i<state.numPlayers;i++){
      const name = state.players[i] && state.players[i].trim() ? state.players[i].trim() : `Player ${i+1}`;
      const card = document.createElement('div'); card.className='card'; card.style.padding='12px';

      const cur = state.scores[state.hole-1]?.[i] ?? null;
      const head = document.createElement('div'); head.className='row'; head.style.justifyContent='space-between';
      head.innerHTML = `<strong>${name}</strong> <span class="badge score ${cur!=null?'selected':''}" data-role="score-badge">Hole ${state.hole} Score: ${cur??'‚Äî'}</span>`;
      card.appendChild(head);

      const grid = document.createElement('div'); grid.className='keypad';
      const makeBtn = (label)=>{ const b=document.createElement('button'); b.className='btn'; b.textContent=label; return b; };
      const setScoreAndRerender = (v)=>{ setScore(state.hole-1,i,v); renderScoring(); };

      // Left arrow (2 -> 1 -> clear)
      const left = makeBtn('‚Üê'); if(cur===1 || cur===2) left.classList.add('primary');
      left.onclick = ()=>{ const c = state.scores[state.hole-1]?.[i];
        if(c===2) setScoreAndRerender(1); else if(c===1) setScoreAndRerender(null); else setScoreAndRerender(2); };
      grid.appendChild(left);

      // 3,4,5,6
      [3,4,5,6].forEach(n=>{ const b = makeBtn(String(n)); if(cur===n) b.classList.add('primary'); b.onclick = ()=> setScoreAndRerender(n); grid.appendChild(b); });

      // Right arrow (7 -> 8 -> 9 -> 10 -> clear)
      const right = makeBtn('‚Üí'); if([7,8,9,10].includes(cur)) right.classList.add('primary');
      right.onclick = ()=>{ const c = state.scores[state.hole-1]?.[i];
        if(c===7) setScoreAndRerender(8); else if(c===8) setScoreAndRerender(9);
        else if(c===9) setScoreAndRerender(10); else if(c===10) setScoreAndRerender(null); else setScoreAndRerender(7); };
      grid.appendChild(right);

      // Clear
      const clearBtn = document.createElement('button'); clearBtn.className='btn ghost'; clearBtn.textContent='Clear';
      clearBtn.onclick = ()=> setScoreAndRerender(null);
      const row = document.createElement('div'); row.className='row'; row.style.marginTop='8px'; row.appendChild(clearBtn);

      card.appendChild(grid); card.appendChild(row);
      keypads.appendChild(card);
    }

    // Matrix + payouts
    renderMatchGrid();
    renderPayouts();
  }

  function setScore(holeIdx, playerIdx, val){
    state.scores[holeIdx][playerIdx] = val===null?null:clamp(parseInt(val,10),1,10);
    save();
  }

  function matchStatus(i,j, uptoHole = state.holes){
    let diff = 0;
    for(let h=0; h<uptoHole; h++){
      const a = state.scores[h]?.[i];
      const b = state.scores[h]?.[j];
      if(a!=null && b!=null){
        if(a<b) diff += 1; else if(a>b) diff -= 1;
      }
    }
    let text = 'AS';
    if(diff>0) text = `${state.players[i] && state.players[i].trim()?state.players[i].trim():('Player '+(i+1))} ${Math.abs(diff)} Up`;
    if(diff<0) text = `${state.players[j] && state.players[j].trim()?state.players[j].trim():('Player '+(j+1))} ${Math.abs(diff)} Up`;
    return {diff, text};
  }

  /* ---- FIXED: True head-to-head matrix ---- */
  function renderMatchGrid(){
    const container = document.getElementById('matchGrid');
    if(!container) return;

    container.innerHTML = '';

    const table = document.createElement('table');
    table.className = 'h2h';

    // Header row
    const thead = document.createElement('thead');
    const hr = document.createElement('tr');
    hr.appendChild(document.createElement('th')); // corner empty
    for (let c = 0; c < state.numPlayers; c++){
      const name = (state.players[c] && state.players[c].trim()) ? state.players[c].trim() : `Player ${c+1}`;
      const th = document.createElement('th');
      th.textContent = name;
      hr.appendChild(th);
    }
    thead.appendChild(hr);
    table.appendChild(thead);

    // Body rows
    const tbody = document.createElement('tbody');
    for (let r = 0; r < state.numPlayers; r++){
      const tr = document.createElement('tr');

      const rowName = (state.players[r] && state.players[r].trim()) ? state.players[r].trim() : `Player ${r+1}`;
      const rowTh = document.createElement('th');
      rowTh.textContent = rowName;
      tr.appendChild(rowTh);

      for (let c = 0; c < state.numPlayers; c++){
        const td = document.createElement('td');

        if (r === c){
          td.textContent = '‚Äî';
          td.className = 'self';
        } else {
          const { diff } = matchStatus(r, c, state.hole);
          const badge = document.createElement('span');
          const label = diff === 0 ? 'AS' : (diff > 0 ? `${Math.abs(diff)} Up` : `${Math.abs(diff)} Down`);
          badge.className = 'badge ' + (diff === 0 ? 'as' : diff > 0 ? 'up' : 'down');
          badge.textContent = label;
          td.appendChild(badge);
        }

        tr.appendChild(td);
      }

      tbody.appendChild(tr);
    }

    table.appendChild(tbody);
    container.appendChild(table);
  }

  function segmentWinner(i,j,start,end){
    const msEnd = matchStatus(i,j,end).diff;
    const msBefore = matchStatus(i,j,start-1).diff;
    const seg = msEnd - msBefore;
    if(seg>0) return i; if(seg<0) return j; return null;
  }

  function renderPayouts(){
    if(!state.money.playing){ $('#payouts').textContent=''; return; }
    const unit = Number(state.money.unit||0);
    const lines=[];
    for(let i=0;i<state.numPlayers;i++){
      for(let j=i+1;j<state.numPlayers;j++){
        const final = matchStatus(i,j, state.holes).diff;
        let a = (state.players[i]&&state.players[i].trim())?state.players[i].trim():('Player '+(i+1));
        let b = (state.players[j]&&state.players[j].trim())?state.players[j].trim():('Player '+(j+1));
        let txt = `${a} vs ${b} ‚Äî `;
        if(state.money.type==='straight'){
          if(final>0) txt += `${a} wins $${unit}`; else if(final<0) txt += `${b} wins $${unit}`; else txt += `PUSH`;
        } else {
          const segs = [ [1,9,'Front'], [10,18,'Back'], [1,18,'Overall'] ];
          const parts = segs.map(([s,e,label])=>{
            const w = segmentWinner(i,j,s,e);
            if(w===null) return `${label}: PUSH`;
            const nm = (state.players[w]&&state.players[w].trim())?state.players[w].trim():('Player '+(w+1));
            return `${label}: ${nm} +$${unit}`;
          });
          txt += parts.join(' ‚Ä¢ ');
        }
        lines.push(txt);
      }
    }
    $('#payouts').innerHTML = '<strong>Payouts:</strong> ' + lines.join(' &nbsp; | &nbsp; ');
  }

  // --------- Resume / Reset ---------
  function tryShowResume(){
    const saved = load();
    if(saved){
      $('#resumeBtn').style.display='inline-flex';
      $('#resumeBtn').onclick = ()=>{ Object.assign(state, saved); $('#step1').hidden=true; $('#step2').hidden=true; $('#step3').hidden=true; $('#scoring').hidden=false; renderScoring(); };
    }
  }
  $('#resetBtn').onclick = ()=>{ if(confirm('Reset and clear saved round?')){ clearStore(); location.reload(); } };

  // --------- Boot ---------
  (function boot(){
    try{
      showStep(1);
      renderStep1();
      tryShowResume();
    }catch(e){
      console.error(e);
      alert('Init error: '+ e.message);
    }
  })();
  </script>
</body>
</html>
